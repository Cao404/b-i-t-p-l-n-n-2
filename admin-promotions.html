<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Khuyến Mãi - Larkon</title>
  <link rel="stylesheet" href="./css/product.css" />
  <script src="./js/auth-guard.js"></script>
  <style>
    .promo-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }
    .promo-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
    }
    .promo-badge {
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-active { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .badge-scheduled { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .badge-ended { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
    .budget-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
      padding: 12px;
      background: var(--panel-2);
      border-radius: 8px;
    }
    .promo-empty {
      padding: 24px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      border: 1px dashed var(--line);
      border-radius: 8px;
      background: var(--panel-2);
    }
    .promo-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }
    .promo-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .promo-modal {
      width: 100%;
      max-width: 520px;
      background: var(--panel);
      border-radius: 12px;
      border: 1px solid var(--line);
      padding: 20px 20px 16px;
      box-shadow: 0 22px 45px rgba(15, 23, 42, 0.45);
    }
    .promo-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .promo-modal-title {
      font-weight: 700;
      font-size: 16px;
    }
    .promo-modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 999px;
    }
    .promo-modal-close:hover {
      background: var(--panel-2);
    }
    .promo-form {
      display: grid;
      gap: 10px;
      margin-top: 4px;
    }
    .promo-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    .promo-field label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .promo-field input,
    .promo-field select,
    .promo-field textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--panel-2);
      color: var(--text);
      font-size: 13px;
      resize: vertical;
      min-height: 36px;
    }
    .promo-field textarea {
      min-height: 60px;
    }
    .promo-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 14px;
    }
    .btn-secondary {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--line);
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.35);
    }
  </style>
</head>
<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18l-2 11a2 2 0 0 1-2 1H7a2 2 0 0 1-2-1L3 7Z" stroke="#f9a44d" stroke-width="1.5"/><path d="M8 7V5a3 3 0 0 1 3-3h2a3 3 0 0 1 3 3v2" stroke="#f9a44d" stroke-width="1.5"/></svg>
      <span class="brand-text">Larkon</span>
      <div class="toggle-btn" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </div>
    </div>

    <nav class="nav">
      <h6>TỔNG HỢP</h6>
      <a href="dashboard.html"><svg viewBox="0 0 24 24" fill="none"><path d="M3 12l9-8 9 8v8a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8z" stroke="currentColor"/></svg><span>Bảng điều khiển</span></a>
      
      <h6>QUẢN TRỊ</h6>
      <a href="admin-seller-approval.html"><svg viewBox="0 0 24 24" fill="none"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/><circle cx="8.5" cy="7" r="4" stroke="currentColor" stroke-width="2"/><path d="M20 8v6M23 11h-6" stroke="currentColor" stroke-width="2"/></svg><span>Duyệt Người Bán</span></a>
      <a href="admin-content-moderation.html"><svg viewBox="0 0 24 24" fill="none"><path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 0 0 1.946-.806 3.42 3.42 0 0 1 3.438 0 3.42 3.42 0 0 0 1.946.806 3.42 3.42 0 0 1 3.138 3.138 3.42 3.42 0 0 0 .806 1.946 3.42 3.42 0 0 1 0 3.438 3.42 3.42 0 0 0-.806 1.946 3.42 3.42 0 0 1-3.138 3.138 3.42 3.42 0 0 0-1.946.806 3.42 3.42 0 0 1-3.438 0 3.42 3.42 0 0 0-1.946-.806 3.42 3.42 0 0 1-3.138-3.138 3.42 3.42 0 0 0-.806-1.946 3.42 3.42 0 0 1 0-3.438 3.42 3.42 0 0 0 .806-1.946 3.42 3.42 0 0 1 3.138-3.138z" stroke="currentColor" stroke-width="2"/></svg><span>Kiểm Duyệt Nội Dung</span></a>
      <a href="admin-category-attributes.html"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2"/></svg><span>Danh Mục & Thuộc Tính</span></a>
      <a href="admin-promotions.html" class="active"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2"/></svg><span>Khuyến Mãi</span></a>
      <a href="admin-shipping.html"><svg viewBox="0 0 24 24" fill="none"><path d="M1 3h15v13H1zM16 8h4l3 3v5h-7V8z" stroke="currentColor" stroke-width="2"/><circle cx="5.5" cy="18.5" r="2.5" stroke="currentColor" stroke-width="2"/><circle cx="18.5" cy="18.5" r="2.5" stroke="currentColor" stroke-width="2"/></svg><span>Vận Chuyển</span></a>
      <a href="admin-finance.html"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2"/></svg><span>Tài Chính</span></a>
      <a href="admin-disputes.html"><svg viewBox="0 0 24 24" fill="none"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke="currentColor" stroke-width="2"/><path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2"/></svg><span>Khiếu Nại & Tranh Chấp</span></a>
      <a href="admin-reports.html"><svg viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18M7 16l4-4 4 4 6-6" stroke="currentColor" stroke-width="2"/></svg><span>Báo Cáo & Giám Sát</span></a>
      <a href="admin-permissions.html"><svg viewBox="0 0 24 24" fill="none"><rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/></svg><span>Phân Quyền & Nhật Ký</span></a>
    </nav>

    <div class="grow"></div>

    <div class="user">
      <div class="avatar"></div>
      <div style="flex:1">
        <div style="font-weight:700">Admin</div>
        <div class="sub">Quản trị viên</div>
      </div>
      <div class="icon-btn" onclick="logout()" title="Đăng xuất" style="width:32px;height:32px;margin-left:4px">
        <svg viewBox="0 0 24 24" fill="none" width="16" height="16">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <section class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="title">KHUYẾN MÃI & CHÍNH SÁCH</div>
      <div class="actions">
        <div class="icon-btn" title="Chế độ tối">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M21 12a9 9 0 1 1-8-8 7 7 0 0 0 8 8z" stroke="#b9c7e5"/></svg>
        </div>
        <div class="icon-btn" title="Thông báo">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0" stroke="#b9c7e5"/></svg>
        </div>
        <label class="search">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="11" cy="11" r="7" stroke="#7f95bd"/><path d="M21 21l-3.5-3.5" stroke="#7f95bd"/></svg>
          <input placeholder="Tìm kiếm..." />
        </label>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content">
      
      <div class="card">
        <div class="card-header">
          <div style="font-weight:700;font-size:16px">Voucher Nền Tảng</div>
          <button class="btn" onclick="createVoucher()">Tạo Voucher</button>
        </div>
        
        <div style="padding:20px" id="promo-list-container">
          <div id="promo-list"></div>
        </div>
      </div>

      <!-- Footer -->
      <div style="text-align:center;padding:24px 0;color:var(--muted);font-size:13px">
        2025 © Larkon. Được chế tạo bởi <span style="color:var(--accent);font-weight:600">Cao, Trần Huy và Đào Huy</span>
      </div>

    </div>

  </section>
</div>

<!-- Modal tạo / chỉnh sửa khuyến mãi -->
<div class="promo-modal-backdrop" id="promo-modal-backdrop">
  <div class="promo-modal">
    <div class="promo-modal-header">
      <div class="promo-modal-title" id="promo-modal-title">Tạo khuyến mãi</div>
      <button class="promo-modal-close" type="button" onclick="closePromoModal()" aria-label="Đóng">
        ✕
      </button>
    </div>

    <form id="promo-form" class="promo-form">
      <div class="promo-form-row">
        <div class="promo-field">
          <label for="promo-code">Mã khuyến mãi</label>
          <input id="promo-code" name="code" type="text" required placeholder="GIAM50K" />
        </div>
        <div class="promo-field">
          <label for="promo-status">Trạng thái</label>
          <select id="promo-status" name="status" required>
            <option value="active">Đang hoạt động</option>
            <option value="scheduled">Đã lên lịch</option>
            <option value="ended">Đã kết thúc</option>
          </select>
        </div>
      </div>

      <div class="promo-field">
        <label for="promo-description">Mô tả</label>
        <textarea id="promo-description" name="description" placeholder="Giảm 50,000đ cho đơn từ 500,000đ"></textarea>
      </div>

      <div class="promo-form-row">
        <div class="promo-field">
          <label for="promo-budget">Ngân sách (đ)</label>
          <input id="promo-budget" name="budget" type="number" min="0" step="1000" placeholder="50000000" />
        </div>
        <div class="promo-field">
          <label for="promo-used">Đã sử dụng (đ)</label>
          <input id="promo-used" name="used" type="number" min="0" step="1000" placeholder="0" />
        </div>
      </div>

      <div class="promo-form-row">
        <div class="promo-field">
          <label for="promo-start">Ngày bắt đầu</label>
          <input id="promo-start" name="start" type="date" />
        </div>
        <div class="promo-field">
          <label for="promo-end">Ngày kết thúc</label>
          <input id="promo-end" name="end" type="date" />
        </div>
      </div>

      <div class="promo-form-row">
        <div class="promo-field">
          <label for="promo-issued">Số voucher phát hành</label>
          <input id="promo-issued" name="issued" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="promo-field">
          <label for="promo-redeemed">Số voucher đã dùng</label>
          <input id="promo-redeemed" name="redeemed" type="number" min="0" step="1" placeholder="0" />
        </div>
      </div>

      <div class="promo-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closePromoModal()">Hủy</button>
        <button type="submit" class="btn">Lưu</button>
      </div>
    </form>
  </div>
</div>

<script>
  function toggleSidebar() {
    document.querySelector('.layout').classList.toggle('collapsed');
    localStorage.setItem('sidebarCollapsed', document.querySelector('.layout').classList.contains('collapsed'));
  }

  if (localStorage.getItem('sidebarCollapsed') === 'true') {
    document.querySelector('.layout').classList.add('collapsed');
  }

  const PROMO_STORAGE_KEY = 'larkon_admin_promos';
  let promos = [];
  let editingPromoId = null;

  function loadPromos() {
    try {
      const raw = localStorage.getItem(PROMO_STORAGE_KEY);
      if (!raw) {
        promos = [];
        return;
      }
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        promos = parsed;
      } else {
        promos = [];
      }
    } catch (e) {
      console.error('Không thể đọc khuyến mãi từ localStorage', e);
      promos = [];
    }
  }

  function savePromos() {
    try {
      localStorage.setItem(PROMO_STORAGE_KEY, JSON.stringify(promos));
    } catch (e) {
      console.error('Không thể lưu khuyến mãi vào localStorage', e);
    }
  }

  function formatCurrency(value) {
    if (value === null || value === undefined || value === '') return '0đ';
    const num = Number(value) || 0;
    return num.toLocaleString('vi-VN') + 'đ';
  }

  function getStatusBadge(status) {
    switch (status) {
      case 'active':
        return '<span class="promo-badge badge-active">Đang hoạt động</span>';
      case 'scheduled':
        return '<span class="promo-badge badge-scheduled">Đã lên lịch</span>';
      case 'ended':
        return '<span class="promo-badge badge-ended">Đã kết thúc</span>';
      default:
        return '<span class="promo-badge badge-ended">Không xác định</span>';
    }
  }

  function renderPromos() {
    const container = document.getElementById('promo-list');
    if (!container) return;

    if (!promos || promos.length === 0) {
      container.innerHTML = '<div class="promo-empty">Chưa có khuyến mãi nào. Bấm "Tạo Voucher" để thêm mới.</div>';
      return;
    }

    const itemsHtml = promos
      .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
      .map(function (p) {
        const budget = formatCurrency(p.budget);
        const used = formatCurrency(p.used);
        const issued = Number(p.issued || 0);
        const redeemed = Number(p.redeemed || 0);
        const usedPercent = p.budget ? Math.min(100, ((Number(p.used || 0) / Number(p.budget || 1)) * 100)).toFixed(1) : null;
        const redeemedPercent = issued ? Math.min(100, ((redeemed / issued) * 100)).toFixed(1) : null;

        const timeLabel = (p.start || p.end)
          ? [p.start, p.end].filter(Boolean).join(' - ')
          : 'Không giới hạn';

        const budgetInfo = [
          '<div class="budget-info">',
          '  <div>',
          '    <div style="color:var(--muted);font-size:12px">Ngân sách</div>',
          '    <div style="font-weight:700;font-size:16px;margin-top:4px">' + budget + '</div>',
          usedPercent !== null
            ? '    <div style="color:var(--muted);font-size:12px;margin-top:2px">Đã sử dụng: ' + used + ' (' + usedPercent + '%)</div>'
            : '    <div style="color:var(--muted);font-size:12px;margin-top:2px">Đã sử dụng: ' + used + '</div>',
          '  </div>',
          '  <div>',
          '    <div style="color:var(--muted);font-size:12px">Thời gian</div>',
          '    <div style="font-weight:700;font-size:16px;margin-top:4px">' + timeLabel + '</div>',
          '    <div style="color:var(--muted);font-size:12px;margin-top:2px">Trạng thái: ' + (p.statusLabel || '') + '</div>',
          '  </div>',
          '  <div>',
          '    <div style="color:var(--muted);font-size:12px">Voucher</div>',
          '    <div style="font-weight:700;font-size:16px;margin-top:4px">' + issued + ' voucher</div>',
          redeemedPercent !== null
            ? '    <div style="color:var(--muted);font-size:12px;margin-top:2px">Đã dùng: ' + redeemed + ' (' + redeemedPercent + '%)</div>'
            : '    <div style="color:var(--muted);font-size:12px;margin-top:2px">Đã dùng: ' + redeemed + '</div>',
          '  </div>',
          '</div>'
        ].join('');

        var actions = [
          '<button class="btn btn-secondary" onclick="editPromo(' + p.id + ')">Chỉnh sửa</button>'
        ];

        if (p.status !== 'ended') {
          actions.push('<button class="btn" style="background:rgba(239,68,68,0.2);color:#ef4444;border:1px solid rgba(239,68,68,0.3)" onclick="endPromo(' + p.id + ')">Kết thúc</button>');
        }

        actions.push('<button class="btn btn-danger" onclick="deletePromo(' + p.id + ')">Xóa</button>');

        return [
          '<div class="promo-card">',
          '  <div class="promo-header">',
          '    <div>',
          '      <div style="font-weight:700;font-size:18px">' + (p.code || '') + '</div>',
          '      <div style="color:var(--muted);font-size:13px;margin-top:4px">' + (p.description || '') + '</div>',
          '    </div>',
          '    ' + getStatusBadge(p.status || 'active'),
          '  </div>',
          budgetInfo,
          '  <div class="promo-actions">' + actions.join('') + '</div>',
          '</div>'
        ].join('');
      })
      .join('');

    container.innerHTML = itemsHtml;
  }

  function openPromoModal(mode, promo) {
    const backdrop = document.getElementById('promo-modal-backdrop');
    const title = document.getElementById('promo-modal-title');
    const form = document.getElementById('promo-form');

    if (!backdrop || !title || !form) return;

    title.textContent = mode === 'edit' ? 'Chỉnh sửa khuyến mãi' : 'Tạo khuyến mãi';

    document.getElementById('promo-code').value = promo?.code || '';
    document.getElementById('promo-description').value = promo?.description || '';
    document.getElementById('promo-budget').value = promo?.budget || '';
    document.getElementById('promo-used').value = promo?.used || '';
    document.getElementById('promo-start').value = promo?.start || '';
    document.getElementById('promo-end').value = promo?.end || '';
    document.getElementById('promo-issued').value = promo?.issued || '';
    document.getElementById('promo-redeemed').value = promo?.redeemed || '';
    document.getElementById('promo-status').value = promo?.status || 'active';

    backdrop.style.display = 'flex';
  }

  function closePromoModal() {
    const backdrop = document.getElementById('promo-modal-backdrop');
    if (backdrop) {
      backdrop.style.display = 'none';
    }
    editingPromoId = null;
  }

  function createVoucher() {
    editingPromoId = null;
    openPromoModal('create', null);
  }

  function editPromo(id) {
    const promo = promos.find(function (p) { return String(p.id) === String(id); });
    if (!promo) {
      alert('Không tìm thấy khuyến mãi để chỉnh sửa');
      return;
    }
    editingPromoId = promo.id;
    openPromoModal('edit', promo);
  }

  function endPromo(id) {
    if (confirm('Bạn có chắc muốn kết thúc khuyến mãi này?')) {
      const index = promos.findIndex(function (p) { return String(p.id) === String(id); });
      if (index === -1) {
        alert('Không tìm thấy khuyến mãi');
        return;
      }
      promos[index].status = 'ended';
      promos[index].statusLabel = 'Đã kết thúc';
      savePromos();
      renderPromos();
      alert('Đã kết thúc khuyến mãi!');
    }
  }

  function cancelPromo(id) {
    if (confirm('Bạn có chắc muốn hủy khuyến mãi này?')) {
      deletePromo(id);
      alert('Đã hủy khuyến mãi!');
    }
  }

  function deletePromo(id) {
    const index = promos.findIndex(function (p) { return String(p.id) === String(id); });
    if (index === -1) {
      alert('Không tìm thấy khuyến mãi');
      return;
    }
    promos.splice(index, 1);
    savePromos();
    renderPromos();
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadPromos();

    if (!promos || promos.length === 0) {
      promos = [
        {
          id: Date.now(),
          code: 'GIAM50K',
          description: 'Giảm 50,000đ cho đơn từ 500,000đ',
          budget: 50000000,
          used: 23450000,
          start: '2025-01-01',
          end: '2025-01-31',
          issued: 469,
          redeemed: 234,
          status: 'active',
          statusLabel: 'Đang hoạt động',
          createdAt: Date.now()
        }
      ];
      savePromos();
    }

    renderPromos();

    const form = document.getElementById('promo-form');
    if (form) {
      form.addEventListener('submit', function (event) {
        event.preventDefault();

        const code = document.getElementById('promo-code').value.trim();
        if (!code) {
          alert('Vui lòng nhập mã khuyến mãi');
          return;
        }

        const promoData = {
          code: code,
          description: document.getElementById('promo-description').value.trim(),
          budget: Number(document.getElementById('promo-budget').value || 0),
          used: Number(document.getElementById('promo-used').value || 0),
          start: document.getElementById('promo-start').value,
          end: document.getElementById('promo-end').value,
          issued: Number(document.getElementById('promo-issued').value || 0),
          redeemed: Number(document.getElementById('promo-redeemed').value || 0),
          status: document.getElementById('promo-status').value,
          statusLabel:
            document.getElementById('promo-status').value === 'active'
              ? 'Đang hoạt động'
              : document.getElementById('promo-status').value === 'scheduled'
              ? 'Đã lên lịch'
              : 'Đã kết thúc'
        };

        if (editingPromoId !== null && editingPromoId !== undefined) {
          const index = promos.findIndex(function (p) { return String(p.id) === String(editingPromoId); });
          if (index !== -1) {
            promos[index] = Object.assign({}, promos[index], promoData);
          }
        } else {
          promoData.id = Date.now();
          promoData.createdAt = Date.now();
          promos.push(promoData);
        }

        savePromos();
        renderPromos();
        closePromoModal();
      });
    }

    const backdrop = document.getElementById('promo-modal-backdrop');
    if (backdrop) {
      backdrop.addEventListener('click', function (event) {
        if (event.target === backdrop) {
          closePromoModal();
        }
      });
    }
  });
</script>
</body>
</html>



